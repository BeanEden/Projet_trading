{% extends "base.html" %}
{% block title %}Pr√©diction ‚Äî {{ model_name }} {{ version }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('user_dashboard') }}">Utilisateur</a>
    <span class="sep">/</span>
    <span>Pr√©diction</span>
</div>

<div class="page-header">
    <h2>üîÆ Pr√©diction ‚Äî {{ model_name }} <span class="badge badge-green">{{ version }}</span></h2>
    <p>R√©sultat du mod√®le sur les donn√©es 2024 (test set jamais vu √† l'entra√Ænement).</p>
</div>

<!-- Granularity Tabs -->
<div class="tab-group mb-3">
    <a href="{{ url_for('user_predict', model_name=model_name, version=version, granularity='1D') }}"
        class="tab-item {% if granularity == '1D' %}active{% endif %}">üìÜ Jour</a>
    <a href="{{ url_for('user_predict', model_name=model_name, version=version, granularity='1W') }}"
        class="tab-item {% if granularity == '1W' %}active{% endif %}">üìÖ Semaine</a>
    <a href="{{ url_for('user_predict', model_name=model_name, version=version, granularity='1ME') }}"
        class="tab-item {% if granularity == '1ME' %}active{% endif %}">üóìÔ∏è Mois</a>
</div>

{% if prediction and 'error' not in prediction %}

<!-- M√©triques r√©sum√© -->
<div class="grid-3 mb-3">
    <div class="stat-card">
        <div class="stat-label">Accuracy Globale 2024</div>
        <div class="stat-value {% if prediction.global_accuracy > 0.52 %}text-green{% else %}text-red{% endif %}">
            {{ "%.1f"|format(prediction.global_accuracy * 100) }}%
        </div>
        <div class="stat-change {% if prediction.global_accuracy > 0.52 %}positive{% else %}negative{% endif %}">
            {{ "Au-dessus du seuil de 50%" if prediction.global_accuracy > 0.5 else "En dessous du seuil de 50%" }}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">P√©riodes analys√©es</div>
        <div class="stat-value">{{ prediction.nb_periods }}</div>
        <div class="stat-change">Granularit√© : {{ {'1D': 'Journali√®re', '1W': 'Hebdomadaire', '1ME':
            'Mensuelle'}.get(granularity, granularity) }}</div>
    </div>
    {% if evaluation and evaluation.roc_auc is defined %}
    <div class="stat-card">
        <div class="stat-label">ROC AUC</div>
        <div class="stat-value text-mono">{{ "%.4f"|format(evaluation.roc_auc) }}</div>
        <div class="stat-change">Qualit√© du classement</div>
    </div>
    {% endif %}
</div>

<!-- Graphique principal -->
<div class="card mb-3">
    <div class="card-title"><span class="icon">üìä</span> Pr√©dictions vs R√©el ‚Äî {{ {'1D': 'Jour', '1W': 'Semaine', '1ME':
        'Mois'}.get(granularity, granularity) }}</div>
    {% if prediction.image %}
    <div class="chart-container">
        <img src="{{ prediction.image }}" alt="Predictions Chart" style="max-width: 100%;">
    </div>
    {% endif %}

    <div class="mt-2">
        <div
            class="assessment-box {% if prediction.global_accuracy > 0.55 %}positive{% elif prediction.global_accuracy > 0.51 %}neutral{% else %}negative{% endif %}">
            <strong>Interpr√©tation :</strong>
            {% if prediction.global_accuracy > 0.55 %}
            Le mod√®le pr√©sente une accuracy sup√©rieure √† 55% ‚Äî il capture un signal exploitable.
            Les barres vertes montrent les p√©riodes profitables. Plus la granularit√© est fine (jour), plus le mod√®le
            montre sa capacit√© de pr√©diction √† court terme.
            {% elif prediction.global_accuracy > 0.51 %}
            Le mod√®le est l√©g√®rement au-dessus du hasard. L'edge est faible et pourrait √™tre absorb√© par les frais de
            transaction.
            Essayez d'am√©liorer les features ou de changer d'algorithme.
            {% else %}
            Le mod√®le ne surpasse pas le hasard sur cette p√©riode.
            Il n'est pas recommand√© de l'utiliser en production.
            {% endif %}
            <br><br>
            <strong>üí° Court terme vs Long terme :</strong>
            Le march√© des changes (Forex) est plus pr√©dictible √† court terme (intra-journalier) qu'√† long terme.
            Passez de "Jour" √† "Semaine" et "Mois" pour observer cette tendance.
        </div>
    </div>
</div>

<!-- Param√®tres du mod√®le -->
{% if prediction.meta %}
<div class="card mb-3">
    <div class="card-title"><span class="icon">‚öôÔ∏è</span> Param√®tres du Mod√®le</div>
    <div class="grid-3">
        <div>
            <div class="stat-label">Algorithme</div>
            <div style="font-weight: 600; margin-top: 4px;">{{ prediction.meta.get('algorithm', 'N/A') }}</div>
        </div>
        <div>
            <div class="stat-label">Entra√Æn√© le</div>
            <div style="font-weight: 600; margin-top: 4px;">{{ prediction.meta.get('timestamp', '')[:10] }}</div>
        </div>
        <div>
            <div class="stat-label">Auteur</div>
            <div style="font-weight: 600; margin-top: 4px;">{{ prediction.meta.get('author', 'N/A') }}</div>
        </div>
    </div>
    {% if prediction.meta.params %}
    <div class="mt-2">
        <div class="stat-label mb-1">Hyperparam√®tres</div>
        <div class="checkbox-group">
            {% for k, v in prediction.meta.params.items() %}
            <span class="badge badge-muted">{{ k }} = {{ v }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if prediction.meta.features is defined %}
    <div class="mt-2">
        <div class="stat-label mb-1">Features utilis√©es</div>
        <div class="checkbox-group">
            {% for feat in prediction.meta.features %}
            <span class="badge badge-gold">{{ feat }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Classification Report r√©sum√© -->
{% if evaluation and evaluation.classification_report %}
<div class="card">
    <div class="card-title"><span class="icon">üìã</span> Performance D√©taill√©e (Classification Report)</div>
    <div class="report-grid">
        <div class="report-metric">
            <div class="value">{{ "%.1f"|format(evaluation.accuracy * 100) }}%</div>
            <div class="label">Accuracy</div>
        </div>
        {% set cr = evaluation.classification_report %}
        {% if 'macro avg' in cr %}
        <div class="report-metric">
            <div class="value">{{ "%.1f"|format(cr['macro avg']['precision'] * 100) }}%</div>
            <div class="label">Precision</div>
        </div>
        <div class="report-metric">
            <div class="value">{{ "%.1f"|format(cr['macro avg']['recall'] * 100) }}%</div>
            <div class="label">Recall</div>
        </div>
        <div class="report-metric">
            <div class="value">{{ "%.1f"|format(cr['macro avg']['f1-score'] * 100) }}%</div>
            <div class="label">F1-Score</div>
        </div>
        {% endif %}
    </div>

    <div class="text-muted mt-2" style="font-size: 12px;">
        <strong>Guide de lecture :</strong>
        <ul style="padding-left: 18px; line-height: 2;">
            <li><strong>Accuracy ~50%</strong> : Mod√®le al√©atoire (coin toss). Non exploitable.</li>
            <li><strong>Accuracy 52-55%</strong> : Signal faible. Peut √™tre profitable avec un bon money management.
            </li>
            <li><strong>Accuracy >55%</strong> : Signal solide. Le mod√®le a appris un pattern r√©el du march√©.</li>
            <li><strong>Precision</strong> : Parmi les pr√©dictions "Hausse", quel % est vrai ?</li>
            <li><strong>Recall</strong> : Parmi les vraies "Hausse", quel % est d√©tect√© ?</li>
        </ul>
    </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-danger">
    {{ prediction.error if prediction and prediction.error is defined else "Erreur lors de la pr√©diction. V√©rifiez que
    l'API FastAPI est d√©marr√©e." }}
</div>
{% endif %}
{% endblock %}