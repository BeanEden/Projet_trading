{% extends "base.html" %}
{% block title %}Entra√Æner un Mod√®le{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üß† Entra√Æner un Nouveau Mod√®le</h2>
    <p>Configurez l'algorithme, les hyperparam√®tres et les features pour cr√©er une nouvelle version.</p>
</div>

{% if result %}
{% if result.error is defined %}
<div class="alert alert-danger">‚ùå {{ result.error }}</div>
{% else %}
<div class="alert alert-success">
    ‚úÖ Mod√®le entra√Æn√© avec succ√®s ! Version <strong>{{ result.version }}</strong> cr√©√©e.
    <br>Accuracy : <strong>{{ "%.2f%%"|format(result.metrics.accuracy * 100) }}</strong>
    | F1 : <strong>{{ "%.4f"|format(result.metrics.f1_score) }}</strong>
    {% if result.metrics.roc_auc is defined %}| AUC : <strong>{{ "%.4f"|format(result.metrics.roc_auc) }}</strong>{%
    endif %}

    <hr>

    <!-- R√©sultats graphiques -->
    <div class="grid-3">
        {% if result.confusion %}
        <div class="card p-2" style="background:#fff; color:#000;">
            <img src="{{ result.confusion }}" class="img-fluid" style="border-radius:4px;">
        </div>
        {% endif %}

        {% if result.roc %}
        <div class="card p-2" style="background:#fff; color:#000;">
            <img src="{{ result.roc }}" class="img-fluid" style="border-radius:4px;">
        </div>
        {% endif %}

        {% if result.importance %}
        <div class="card p-2" style="background:#fff; color:#000;">
            <img src="{{ result.importance }}" class="img-fluid" style="border-radius:4px;">
        </div>
        {% endif %}
    </div>

    {% if result.grid_search %}
    <hr>
    <div>
        üîç <strong>Meilleurs hyperparam√®tres (Grid Search) :</strong>
        <ul style="margin-bottom:0; padding-left:20px;">
            {% for k, v in result.best_params.items() %}
            <li>{{ k }}: <strong>{{ v }}</strong></li>
            {% endfor %}
        </ul>
        <small class="text-muted">Score validation crois√©e : {{ "%.4f"|format(result.grid_search.best_score) }}</small>
    </div>
    {% endif %}

    <div style="margin-top:10px; text-align:right;">
        <a href="{{ url_for('programmer_evaluate', model_name=request.form.model_name|default('rf_direction_classifier'), version=result.version) }}"
            class="btn btn-sm btn-outline-primary">üìä Voir Rapport Complet</a>
    </div>
</div>
{% endif %}
{% endif %}

<div class="grid-2">
    <!-- Formulaire d'entra√Ænement -->
    <div class="card">
        <div class="card-title"><span class="icon">‚öôÔ∏è</span> Configuration</div>
        <form method="POST">
            <div class="form-group">
                <label for="model_name">Nom du Mod√®le</label>
                <input type="text" id="model_name" name="model_name" class="form-control"
                    value="rf_direction_classifier" required>
            </div>

            <div class="form-group">
                <label for="author">Auteur</label>
                <input type="text" id="author" name="author" class="form-control" value="JCLoirat">
            </div>

            <div class="form-group">
                <label for="algorithm">Algorithme</label>
                <select id="algorithm" name="algorithm" class="form-control" onchange="toggleParams()">
                    <option value="RandomForest">üå≥ Random Forest</option>
                    <option value="GradientBoosting">üöÄ Gradient Boosting</option>
                    <option value="LogisticRegression">üìè Logistic Regression</option>
                </select>

                <div class="mt-2" style="display:flex; align-items:center;">
                    <input type="checkbox" id="grid_search" name="grid_search" style="margin-right:8px;">
                    <label for="grid_search" style="margin-bottom:0; font-weight:normal; cursor:pointer;">
                        Utiliser <strong>Grid Search CV</strong> (Optimisation Auto)
                    </label>
                </div>
            </div>

            <!-- Params RF / GB -->
            <div id="params-tree">
                <div class="grid-2">
                    <div class="form-group">
                        <label for="n_estimators">Nombre d'arbres</label>
                        <input type="number" id="n_estimators" name="n_estimators" class="form-control" value="100"
                            min="10" max="1000">
                    </div>
                    <div class="form-group">
                        <label for="max_depth">Profondeur max</label>
                        <input type="number" id="max_depth" name="max_depth" class="form-control" value="5" min="1"
                            max="30">
                    </div>
                </div>
            </div>

            <!-- Params GB extra -->
            <div id="params-gb" style="display:none;">
                <div class="form-group">
                    <label for="learning_rate">Learning Rate</label>
                    <input type="number" id="learning_rate" name="learning_rate" class="form-control" value="0.1"
                        min="0.001" max="1" step="0.01">
                </div>
            </div>

            <!-- Params LR -->
            <div id="params-lr" style="display:none;">
                <div class="form-group">
                    <label for="C">R√©gularisation C</label>
                    <input type="number" id="C" name="C" class="form-control" value="1.0" min="0.01" max="100"
                        step="0.1">
                </div>
            </div>

            <!-- Features -->
            <div class="form-group">
                <label>Features √† utiliser</label>
                <div class="checkbox-group">
                    {% for col in columns %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="features" value="{{ col }}" {% if col in ['rsi_14', 'ema_20'
                            , 'ema_50' , 'atr_14' , 'adx_14' ] %}checked{% endif %}>
                        {{ col }}
                    </label>
                    {% endfor %}
                </div>
                <small class="text-muted mt-1" style="display:block;">
                    ‚ÑπÔ∏è S√©lectionnez les features les plus pertinentes. Trop de features ‚Üí risque d'overfit.
                </small>
            </div>

            <button type="submit" id="trainBtn" class="btn btn-primary">üöÄ Lancer l'entra√Ænement</button>
        </form>

        <!-- Loading overlay -->
        <div id="loadingOverlay"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(44,40,38,0.6); z-index:9999; display:none; align-items:center; justify-content:center;">
            <div class="card" style="text-align:center; padding:40px 60px; max-width:420px;">
                <div style="font-size:40px; margin-bottom:16px; animation: spin 1.5s linear infinite;">‚öôÔ∏è</div>
                <h3 style="margin-bottom:8px;">Entra√Ænement en cours‚Ä¶</h3>
                <p class="text-muted" style="font-size:13px;">Chargement des donn√©es (3 ann√©es) + entra√Ænement du
                    mod√®le.<br>Cela peut prendre <strong>60 √† 90 secondes</strong>.</p>
                <div
                    style="margin-top:16px; height:4px; background:var(--bg-secondary); border-radius:4px; overflow:hidden;">
                    <div
                        style="height:100%; background:linear-gradient(90deg, var(--accent-warm), var(--accent-gold)); animation: progress 3s ease-in-out infinite; width:30%; border-radius:4px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide -->
    <div>
        <div class="card mb-2">
            <div class="card-title"><span class="icon">üìñ</span> Guide Algorithmes</div>
            <div class="timeline">
                <div class="timeline-item">
                    <strong>üå≥ Random Forest</strong>
                    <p class="text-muted" style="font-size: 13px; margin-top: 4px;">
                        Ensemble d'arbres de d√©cision. Robuste, peu sensible √† l'overfit.
                        <br><strong>Params cl√©s :</strong> n_estimators (+ = + stable), max_depth (+ = + complexe).
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>üöÄ Gradient Boosting</strong>
                    <p class="text-muted" style="font-size: 13px; margin-top: 4px;">
                        Arbres s√©quentiels corrigeant les erreurs. Plus puissant mais plus sensible au surapprentissage.
                        <br><strong>Params cl√©s :</strong> learning_rate (bas = prudent), n_estimators, max_depth.
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>üìè Logistic Regression</strong>
                    <p class="text-muted" style="font-size: 13px; margin-top: 4px;">
                        Mod√®le lin√©aire simple. Sert de baseline. Si un RF ne bat pas la LR, les features sont
                        insuffisantes.
                        <br><strong>Params cl√©s :</strong> C (haut = moins de r√©gularisation).
                    </p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">‚ö†Ô∏è</span> Bonnes pratiques</div>
            <ul style="font-size: 13px; color: var(--text-secondary); padding-left: 20px; line-height: 2;">
                <li>Commencez avec un mod√®le simple (LR) comme baseline</li>
                <li>Augmentez la complexit√© progressivement</li>
                <li>Si accuracy < 52%, le mod√®le n'est <strong>pas exploitable</strong></li>
                <li>Comparez toujours avec la version pr√©c√©dente</li>
                <li>Ne publiez que les mod√®les valid√©s sur le test set</li>
            </ul>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    @keyframes progress {
        0% {
            margin-left: 0;
            width: 30%;
        }

        50% {
            margin-left: 40%;
            width: 50%;
        }

        100% {
            margin-left: 0;
            width: 30%;
        }
    }
</style>
<script>
    function toggleParams() {
        const algo = document.getElementById('algorithm').value;
        document.getElementById('params-tree').style.display = ['RandomForest', 'GradientBoosting'].includes(algo) ? '' : 'none';
        document.getElementById('params-gb').style.display = algo === 'GradientBoosting' ? '' : 'none';
        document.getElementById('params-lr').style.display = algo === 'LogisticRegression' ? '' : 'none';
    }

    // Form submit: validate features + show loading
    document.querySelector('form').addEventListener('submit', function (e) {
        const checked = document.querySelectorAll('input[name="features"]:checked');
        if (checked.length === 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è Veuillez s√©lectionner au moins une feature.');
            return;
        }
        // Show loading overlay
        const overlay = document.getElementById('loadingOverlay');
        const overlayTitle = document.querySelector('#loadingOverlay h3');
        const overlayText = document.querySelector('#loadingOverlay p');
        const isGrid = document.getElementById('grid_search').checked;

        let steps = [];
        let delays = [];

        if (isGrid) {
            steps = [
                'Initialisation de Grid Search...',
                'Chargement des donn√©es (3 ann√©es)...',
                'Exploration des hyperparam√®tres...',
                'Validation crois√©e (CV=3)...',
                'S√©lection du meilleur mod√®le...',
                'Entra√Ænement final...',
                'G√©n√©ration des graphiques...'
            ];
            delays = [0, 1500, 3500, 8000, 15000, 20000, 25000]; // Simulated delays
            overlayTitle.innerText = 'Optimisation en cours‚Ä¶';
            overlayText.innerHTML = 'Recherche des meilleurs hyperparam√®tres avec <strong>GridSearch CV</strong>.<br>Cela peut prendre quelques minutes.';
        } else {
            steps = [
                'Initialisation...',
                'Chargement des donn√©es (3 ann√©es)...',
                'Entra√Ænement du mod√®le...',
                'Validation sur le jeu de test...',
                'Calcul des m√©triques...',
                'Finalisation...'
            ];
            delays = [0, 1000, 3000, 5000, 7000, 8500];
            overlayTitle.innerText = 'Entra√Ænement en cours‚Ä¶';
            overlayText.innerHTML = 'Chargement des donn√©es + entra√Ænement du mod√®le.<br>Veuillez patienter...';
        }

        overlay.style.display = 'flex';

        // Progress simulation
        delays.forEach((delay, index) => {
            setTimeout(() => {
                if (steps[index]) {
                    overlayText.innerHTML = `<strong>${steps[index]}</strong><br>Veuillez patienter...`;
                }
            }, delay);
        });

        // Disable button
        const btn = document.getElementById('trainBtn');
        btn.disabled = true;
        btn.innerHTML = isGrid ? '‚è≥ Optimisation‚Ä¶' : '‚è≥ Entra√Ænement en cours‚Ä¶';
        btn.style.opacity = '0.6';
    });
</script>
{% endblock %}